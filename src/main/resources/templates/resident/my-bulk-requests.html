<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Bulk Requests - SmartBin</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
            color: #202124;
        }

        .navbar {
            background: white;
            padding: 1rem 2rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.08);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .navbar-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.375rem;
            font-weight: 600;
            color: #202124;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .logo .material-icons {
            font-size: 2rem;
            color: #34a853;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .user-info span {
            font-weight: 500;
            color: #5f6368;
            font-size: 0.9rem;
        }

        .btn-logout {
            background: white;
            color: #1a73e8;
            border: 1px solid #dadce0;
            padding: 0.5rem 1.5rem;
            border-radius: 24px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.2s;
            font-size: 0.875rem;
        }

        .btn-logout:hover {
            background: #f8f9fa;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Header */
        .header {
            padding: 1.5rem 0;
            margin-bottom: 2rem;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 2rem;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .header h1 {
            font-size: 1.75rem;
            font-weight: 400;
            color: #202124;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin: 0;
            letter-spacing: -0.5px;
        }

        .header .material-icons {
            font-size: 2rem;
            color: #34a853;
        }

        .back-link {
            color: #5f6368;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            transition: all 0.2s;
            background: white;
            border: 1px solid #dadce0;
        }

        .back-link:hover {
            background: #f8f9fa;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12);
        }

        .back-link .material-icons {
            font-size: 1.25rem;
        }

        .new-request-btn {
            background: #34a853;
            color: white !important;
            border: none;
            padding: 0.75rem 2rem;
            border-radius: 24px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
            transition: all 0.2s;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12);
        }

        .new-request-btn:hover {
            background: #2d904a;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.16);
            color: white !important;
        }

        .new-request-btn .material-icons {
            font-size: 1.125rem;
            color: white !important;
        }

        /* Filters */
        .filters {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            display: flex;
            gap: 1rem;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.08);
            border: 1px solid #e0e0e0;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .filter-group .material-icons {
            color: #5f6368;
            font-size: 1.25rem;
        }

        .filter-group select {
            padding: 0.75rem 1rem;
            border: 1px solid #dadce0;
            border-radius: 8px;
            font-size: 0.875rem;
            cursor: pointer;
            background: white;
            color: #202124;
            font-family: 'Inter', sans-serif;
            transition: all 0.2s;
        }

        .filter-group select:focus {
            outline: none;
            border-color: #1a73e8;
            box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.1);
        }

        .filter-group select:hover {
            border-color: #80868b;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.08);
            border: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: all 0.2s;
        }

        .stat-card:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.16), 0 2px 4px rgba(0, 0, 0, 0.12);
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .stat-icon .material-icons {
            font-size: 2rem;
            color: white;
        }

        .stat-content h3 {
            font-size: 0.75rem;
            color: #5f6368;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-content p {
            font-size: 1.75rem;
            font-weight: 600;
            color: #202124;
            margin-top: 0.25rem;
        }

        /* Requests Grid */
        .requests-grid {
            display: grid;
            gap: 1.5rem;
        }

        .request-card {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.08);
            border: 1px solid #e0e0e0;
            transition: all 0.2s;
        }

        .request-card:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.16), 0 2px 4px rgba(0, 0, 0, 0.12);
        }

        .request-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1.5rem;
        }

        .request-id {
            font-size: 1rem;
            font-weight: 600;
            color: #202124;
        }

        .request-date {
            color: #5f6368;
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 16px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .status-PENDING { background: #fef7e0; color: #b06000; }
        .status-APPROVED { background: #e8f4f9; color: #0c5460; }
        .status-PAYMENT_PENDING { background: #fce8e6; color: #c5221f; }
        .status-PAYMENT_COMPLETED { background: #e6f4ea; color: #137333; }
        .status-COLLECTOR_ASSIGNED { background: #e8f4f9; color: #0c5460; }
        .status-SCHEDULED { background: #e8f0fe; color: #1967d2; }
        .status-IN_PROGRESS { background: #fef7e0; color: #b06000; }
        .status-COMPLETED { background: #e6f4ea; color: #137333; }
        .status-CANCELLED { background: #fce8e6; color: #c5221f; }

        .request-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .detail-item {
            display: flex;
            align-items: start;
            gap: 0.75rem;
        }

        .detail-icon {
            width: 40px;
            height: 40px;
            background: #e8f5e9;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .detail-icon .material-icons {
            font-size: 1.25rem;
            color: #34a853;
        }

        .detail-content h4 {
            font-size: 0.75rem;
            color: #5f6368;
            font-weight: 500;
            margin-bottom: 0.25rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .detail-content p {
            font-size: 0.875rem;
            color: #202124;
            font-weight: 500;
        }

        .request-actions {
            display: flex;
            gap: 1rem;
            padding-top: 1.5rem;
            border-top: 1px solid #e0e0e0;
        }

        .action-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 24px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
            text-decoration: none;
            font-family: 'Inter', sans-serif;
        }

        .btn-primary {
            background: #34a853;
            color: white;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12);
        }

        .btn-primary:hover {
            background: #2d904a;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.16);
        }

        .btn-secondary {
            background: #5f6368;
            color: white;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12);
        }

        .btn-secondary:hover {
            background: #4a4f54;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.16);
        }

        .btn-outline {
            background: white;
            border: 1px solid #dadce0;
            color: #5f6368;
        }

        .btn-outline:hover {
            border-color: #34a853;
            color: #34a853;
            background: #f8f9fa;
        }

        .empty-state {
            background: white;
            border-radius: 12px;
            padding: 4rem 2rem;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.08);
            border: 1px solid #e0e0e0;
        }

        .empty-state .material-icons {
            font-size: 5rem;
            color: #80868b;
            margin-bottom: 1rem;
        }

        .empty-state h3 {
            font-size: 1.5rem;
            color: #202124;
            font-weight: 400;
            margin-bottom: 0.5rem;
        }

        .empty-state p {
            color: #5f6368;
            font-size: 0.875rem;
            margin-bottom: 2rem;
        }

        .empty-state .new-request-btn {
            display: inline-flex;
            padding: 1rem 2.5rem;
            font-size: 0.9375rem;
            box-shadow: 0 2px 6px rgba(52, 168, 83, 0.3);
        }

        .empty-state .new-request-btn:hover {
            box-shadow: 0 4px 12px rgba(52, 168, 83, 0.4);
            transform: translateY(-2px);
        }

        .empty-state .new-request-btn .material-icons {
            font-size: 1.25rem;
            color: white;
            margin: 0;
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .navbar-content {
                flex-wrap: wrap;
                gap: 1rem;
            }

            .logo {
                font-size: 1.25rem;
            }

            .header-content {
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
            }

            .header-left {
                flex-direction: row;
                gap: 1rem;
                align-items: center;
            }

            .header h1 {
                font-size: 1.375rem;
            }

            .new-request-btn {
                width: 100%;
                justify-content: center;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .filters {
                flex-direction: column;
                align-items: stretch;
            }

            .request-details {
                grid-template-columns: 1fr;
            }

            .request-actions {
                flex-direction: column;
            }
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="navbar-content">
            <div class="logo">
                <span class="material-icons">delete_outline</span>
                SmartBin
            </div>
            <div class="user-info">
                <span th:text="${user.name}">User</span>
                <a href="/logout" class="btn-logout">Logout</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <div class="header-left">
                    <a href="/resident/dashboard" class="back-link">
                        <span class="material-icons">arrow_back</span>
                    </a>
                    <h1>
                        <span class="material-icons">list_alt</span>
                        My Bulk Collection Requests
                    </h1>
                </div>
                <a href="/resident/bulk-request" class="new-request-btn">
                    <span class="material-icons">add</span>
                    New Request
                </a>
            </div>
        </div>

        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon" style="background: #1a73e8;">
                    <span class="material-icons">list_alt</span>
                </div>
                <div class="stat-content">
                    <h3>Total Requests</h3>
                    <p th:text="${bulkRequests.size()}">0</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon" style="background: #fbbc04;">
                    <span class="material-icons">hourglass_empty</span>
                </div>
                <div class="stat-content">
                    <h3>Pending</h3>
                    <p id="pendingCount">0</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon" style="background: #34a853;">
                    <span class="material-icons">check_circle</span>
                </div>
                <div class="stat-content">
                    <h3>Completed</h3>
                    <p id="completedCount">0</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon" style="background: #ea4335;">
                    <span class="material-icons">payments</span>
                </div>
                <div class="stat-content">
                    <h3>Total Spent</h3>
                    <p id="totalSpent">LKR 0</p>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="filters">
            <div class="filter-group">
                <span class="material-icons" style="color: #666;">filter_list</span>
                <select id="statusFilter" onchange="filterRequests()">
                    <option value="">All Statuses</option>
                    <option value="PENDING">Pending</option>
                    <option value="PAYMENT_PENDING">Payment Pending</option>
                    <option value="PAYMENT_COMPLETED">Payment Completed</option>
                    <option value="SCHEDULED">Scheduled</option>
                    <option value="COMPLETED">Completed</option>
                    <option value="CANCELLED">Cancelled</option>
                </select>
            </div>
            <div class="filter-group">
                <span class="material-icons" style="color: #666;">category</span>
                <select id="categoryFilter" onchange="filterRequests()">
                    <option value="">All Categories</option>
                    <option value="FURNITURE">Furniture</option>
                    <option value="APPLIANCES">Appliances</option>
                    <option value="ELECTRONICS">Electronics</option>
                    <option value="MATTRESS">Mattress</option>
                    <option value="CONSTRUCTION">Construction Waste</option>
                    <option value="YARD">Yard Waste</option>
                    <option value="OTHER">Other</option>
                </select>
            </div>
        </div>

        <!-- Requests List -->
        <div class="requests-grid" id="requestsGrid">
            <div th:if="${bulkRequests.empty}" class="empty-state">
                <span class="material-icons">inbox</span>
                <h3>No Bulk Collection Requests Yet</h3>
                <p>You haven't made any bulk collection requests. Start by creating your first request!</p>
                <a href="/resident/bulk-request" class="new-request-btn">
                    <span class="material-icons">add</span>
                    Create First Request
                </a>
            </div>

            <div th:each="request : ${bulkRequests}" class="request-card" th:attr="data-status=${request.status}, data-category=${request.category}">
                <div class="request-header">
                    <div>
                        <div class="request-id" th:text="${request.requestId}">BULK-123456</div>
                        <div class="request-date" th:text="'Requested on ' + ${#temporals.format(request.createdAt, 'MMM dd, yyyy HH:mm')}">Requested on Jan 15, 2025 14:30</div>
                    </div>
                    <span class="status-badge" th:classappend="'status-' + ${request.status}" th:text="${request.status.displayName}">Pending</span>
                </div>

                <div class="request-details">
                    <div class="detail-item">
                        <div class="detail-icon">
                            <span class="material-icons">category</span>
                        </div>
                        <div class="detail-content">
                            <h4>Category</h4>
                            <p th:text="${request.category.displayName}">Furniture</p>
                        </div>
                    </div>

                    <div class="detail-item">
                        <div class="detail-icon">
                            <span class="material-icons">location_on</span>
                        </div>
                        <div class="detail-content">
                            <h4>Pickup Address</h4>
                            <p th:text="${request.city}">Colombo</p>
                        </div>
                    </div>

                    <div class="detail-item">
                        <div class="detail-icon">
                            <span class="material-icons">payments</span>
                        </div>
                        <div class="detail-content">
                            <h4>Total Amount</h4>
                            <p th:text="'LKR ' + ${#numbers.formatDecimal(request.totalAmount, 1, 2)}">LKR 4,200.00</p>
                        </div>
                    </div>

                    <div class="detail-item" th:if="${request.scheduledDate != null}">
                        <div class="detail-icon">
                            <span class="material-icons">event</span>
                        </div>
                        <div class="detail-content">
                            <h4>Scheduled Date</h4>
                            <p th:text="${#temporals.format(request.scheduledDate, 'MMM dd, yyyy')}">Jan 20, 2025</p>
                        </div>
                    </div>
                </div>

                <div class="request-actions">
                    <button class="action-btn btn-outline" onclick="viewDetails(this)" th:attr="data-request-id=${request.id}">
                        <span class="material-icons">visibility</span>
                        View Details
                    </button>
                    
                    <button th:if="${request.paymentStatus.name() == 'PENDING'}" class="action-btn btn-primary" th:attr="data-request-id=${request.id}" onclick="proceedToPayment(this)">
                        <span class="material-icons">payment</span>
                        Pay Now
                    </button>
                    
                    <button th:if="${request.status.name() == 'PENDING' || request.status.name() == 'PAYMENT_PENDING'}" class="action-btn btn-secondary" th:attr="data-request-id=${request.id}" onclick="cancelRequest(this)">
                        <span class="material-icons">cancel</span>
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Calculate stats on page load
        document.addEventListener('DOMContentLoaded', function() {
            calculateStats();
        });

        function calculateStats() {
            const cards = document.querySelectorAll('.request-card');
            let pending = 0;
            let completed = 0;
            let totalSpent = 0;

            cards.forEach(card => {
                const status = card.getAttribute('data-status');
                const amountText = card.querySelector('.detail-content p').textContent;
                const amount = parseFloat(amountText.replace('LKR ', '').replace(',', ''));

                if (status.includes('PENDING')) {
                    pending++;
                } else if (status === 'COMPLETED') {
                    completed++;
                    totalSpent += amount;
                }
            });

            document.getElementById('pendingCount').textContent = pending;
            document.getElementById('completedCount').textContent = completed;
            document.getElementById('totalSpent').textContent = 'LKR ' + totalSpent.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
        }

        function filterRequests() {
            const statusFilter = document.getElementById('statusFilter').value;
            const categoryFilter = document.getElementById('categoryFilter').value;
            const cards = document.querySelectorAll('.request-card');

            cards.forEach(card => {
                const status = card.getAttribute('data-status');
                const category = card.getAttribute('data-category');
                
                const statusMatch = !statusFilter || status === statusFilter;
                const categoryMatch = !categoryFilter || category === categoryFilter;
                
                if (statusMatch && categoryMatch) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        function viewDetails(button) {
            const requestId = button.getAttribute('data-request-id');
            window.location.href = '/resident/bulk-request/' + requestId + '/details';
        }

        function proceedToPayment(button) {
            const requestId = button.getAttribute('data-request-id');
            
            // Get request details first - use numeric ID endpoint
            fetch('/resident/bulk-request/by-id/' + requestId + '/details')
                .then(response => response.json())
                .then(data => {
                    // Show payment modal
                    showPaymentModal(data);
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Failed to load request details. Please try again.');
                });
        }
        
        function showPaymentModal(request) {
            // Create modal HTML
            const modalHTML = `
                <div id="paymentModal" style="display: block; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5);">
                    <div style="background: white; margin: 5% auto; padding: 0; border-radius: 16px; max-width: 500px; box-shadow: 0 8px 32px rgba(0,0,0,0.3);">
                        <div style="background: linear-gradient(135deg, #e91e63 0%, #c2185b 100%); color: white; padding: 2rem; border-radius: 16px 16px 0 0;">
                            <h2 style="margin: 0; display: flex; align-items: center; gap: 0.75rem;">
                                <span class="material-icons">payment</span>
                                Complete Payment
                            </h2>
                            <p style="margin: 0.5rem 0 0 0; opacity: 0.9;">Request ID: ${request.requestId}</p>
                        </div>
                        
                        <div style="padding: 2rem;">
                            <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; text-align: center;">
                                <h3 style="margin: 0 0 0.5rem 0; color: #666; font-size: 1rem;">Amount to Pay</h3>
                                <div style="font-size: 2.5rem; font-weight: 700; color: #27ae60;">LKR ${request.totalAmount.toFixed(2)}</div>
                                <p style="margin: 0.5rem 0 0 0; color: #999; font-size: 0.9rem;">Category: ${request.category.displayName}</p>
                            </div>
                            
                            <form id="paymentForm" onsubmit="return processPayment(event, ${request.id})">
                                <div style="margin-bottom: 1.5rem;">
                                    <label style="display: block; margin-bottom: 1rem; font-weight: 600; color: #2c3e50;">Select Payment Method</label>
                                    
                                    <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                                        <label style="display: flex; align-items: center; gap: 1rem; padding: 1rem; border: 2px solid #e9ecef; border-radius: 8px; cursor: pointer;">
                                            <input type="radio" name="paymentMethod" value="CREDIT_CARD" checked>
                                            <span class="material-icons" style="color: #3498db;">credit_card</span>
                                            <div style="flex: 1;">
                                                <div style="font-weight: 600;">Credit/Debit Card</div>
                                                <div style="font-size: 0.85rem; color: #666;">Visa, Mastercard</div>
                                            </div>
                                        </label>
                                        
                                        <label style="display: flex; align-items: center; gap: 1rem; padding: 1rem; border: 2px solid #e9ecef; border-radius: 8px; cursor: pointer;">
                                            <input type="radio" name="paymentMethod" value="UPI">
                                            <span class="material-icons" style="color: #27ae60;">smartphone</span>
                                            <div style="flex: 1;">
                                                <div style="font-weight: 600;">UPI</div>
                                                <div style="font-size: 0.85rem; color: #666;">Google Pay, PhonePe, Paytm</div>
                                            </div>
                                        </label>
                                        
                                        <label style="display: flex; align-items: center; gap: 1rem; padding: 1rem; border: 2px solid #e9ecef; border-radius: 8px; cursor: pointer;">
                                            <input type="radio" name="paymentMethod" value="NET_BANKING">
                                            <span class="material-icons" style="color: #3498db;">account_balance</span>
                                            <div style="flex: 1;">
                                                <div style="font-weight: 600;">Net Banking</div>
                                                <div style="font-size: 0.85rem; color: #666;">All major banks</div>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                                
                                <div style="display: flex; gap: 1rem;">
                                    <button type="button" onclick="closePaymentModal()" style="flex: 1; padding: 1rem; background: #e9ecef; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; color: #2c3e50;">
                                        Cancel
                                    </button>
                                    <button type="submit" style="flex: 1; padding: 1rem; background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                                        <span class="material-icons">lock</span>
                                        Pay LKR ${request.totalAmount.toFixed(2)}
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            
            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }
        
        function closePaymentModal() {
            const modal = document.getElementById('paymentModal');
            if (modal) {
                modal.remove();
            }
        }
        
        function processPayment(event, requestId) {
            event.preventDefault();
            
            const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
            const paymentReference = 'PAY-' + Date.now();
            
            // Show loading
            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalHTML = submitBtn.innerHTML;
            submitBtn.innerHTML = '<span class="material-icons" style="animation: spin 1s linear infinite;">refresh</span> Processing...';
            submitBtn.disabled = true;
            
            // Create form data
            const formData = new FormData();
            formData.append('paymentMethod', paymentMethod);
            formData.append('paymentReference', paymentReference);
            
            // Submit payment
            fetch('/resident/bulk-request/' + requestId + '/payment', {
                method: 'POST',
                body: new URLSearchParams(formData)
            })
            .then(response => {
                if (response.redirected) {
                    window.location.href = response.url;
                } else {
                    return response.text();
                }
            })
            .then(result => {
                if (result) {
                    alert('Payment successful! Your request is being processed.');
                    closePaymentModal();
                    location.reload();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Payment processing failed. Please try again.');
                submitBtn.innerHTML = originalHTML;
                submitBtn.disabled = false;
            });
            
            return false;
        }

        function cancelRequest(button) {
            const requestId = button.getAttribute('data-request-id');
            if (confirm('Are you sure you want to cancel this request?')) {
                fetch('/resident/bulk-request/' + requestId + '/cancel', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => {
                    if (response.ok) {
                        alert('Request cancelled successfully');
                        location.reload();
                    } else {
                        alert('Failed to cancel request');
                    }
                });
            }
        }
    </script>
</body>
</html>

